# RAG知识库训练功能需求文档

## 简介

本功能旨在废弃现有的GraphRAG方式，基于_rag（Dify实现）的优秀架构，在项目中创建一个新的rag文件夹，实现完整的RAG知识库训练流程。该功能将提供文档处理、向量化、索引构建和检索等完整的RAG能力，并与现有的知识库系统无缝集成。

## 需求列表

### 需求1：文档处理和提取

**用户故事：** 作为知识库管理员，我希望系统能够自动处理多种格式的文档，提取文本内容并进行清理，以便为后续的向量化做准备。

#### 验收标准

1. WHEN 用户上传文档到知识库 THEN 系统 SHALL 根据文档类型自动选择合适的提取器（PDF、Word、Excel、Markdown、HTML、TXT等）
2. WHEN 文档提取完成 THEN 系统 SHALL 对提取的文本进行清理和预处理，去除无用字符和格式
3. WHEN 文档内容过长 THEN 系统 SHALL 使用智能分块算法将文档分割为合适大小的文本块
4. IF 文档提取失败 THEN 系统 SHALL 记录错误信息并通知用户
5. WHEN 处理完成 THEN 系统 SHALL 保存处理后的文档块到数据库中

### 需求2：向量化和嵌入

**用户故事：** 作为系统，我需要将处理后的文档文本转换为向量表示，以支持语义搜索和相似度计算。

#### 验收标准

1. WHEN 文档分块完成 THEN 系统 SHALL 使用配置的嵌入模型对文本块进行向量化
2. WHEN 进行批量向量化 THEN 系统 SHALL 支持批量处理以提高效率
3. WHEN 向量化完成 THEN 系统 SHALL 将向量数据存储到向量数据库中
4. IF 向量化失败 THEN 系统 SHALL 支持重试机制和错误恢复
5. WHEN 相同内容重复处理 THEN 系统 SHALL 使用缓存机制避免重复计算

### 需求3：索引构建和管理

**用户故事：** 作为系统，我需要构建高效的索引结构，支持快速的向量检索和全文搜索。

#### 验收标准

1. WHEN 向量化完成 THEN 系统 SHALL 构建向量索引以支持高效检索
2. WHEN 需要全文搜索 THEN 系统 SHALL 构建关键词索引
3. WHEN 索引构建完成 THEN 系统 SHALL 更新知识库训练状态为已完成
4. IF 索引构建失败 THEN 系统 SHALL 回滚已处理的数据并记录错误
5. WHEN 文档更新或删除 THEN 系统 SHALL 支持增量索引更新

### 需求4：混合检索实现

**用户故事：** 作为用户，我希望能够通过自然语言查询知识库，获得准确和相关的搜索结果。

#### 验收标准

1. WHEN 用户提交查询 THEN 系统 SHALL 支持语义搜索、全文搜索和混合搜索
2. WHEN 执行语义搜索 THEN 系统 SHALL 将查询转换为向量并计算相似度
3. WHEN 执行全文搜索 THEN 系统 SHALL 使用关键词匹配进行检索
4. WHEN 使用混合搜索 THEN 系统 SHALL 结合语义和关键词搜索结果
5. WHEN 检索完成 THEN 系统 SHALL 支持结果重排序以提高相关性

### 需求5：异步训练任务

**用户故事：** 作为知识库管理员，我希望训练过程在后台异步执行，不阻塞其他操作，并能实时查看训练进度。

#### 验收标准

1. WHEN 用户启动训练 THEN 系统 SHALL 创建异步训练任务
2. WHEN 训练任务执行 THEN 系统 SHALL 更新训练状态和进度信息
3. WHEN 训练完成 THEN 系统 SHALL 通知用户并更新知识库状态
4. IF 训练失败 THEN 系统 SHALL 记录详细错误信息并支持重试
5. WHEN 多个训练任务 THEN 系统 SHALL 支持队列管理避免资源冲突

### 需求6：配置管理和优化

**用户故事：** 作为系统管理员，我希望能够灵活配置RAG参数，优化训练和检索性能。

#### 验收标准

1. WHEN 配置RAG参数 THEN 系统 SHALL 支持文本分块大小、重叠度、向量维度等参数配置
2. WHEN 选择嵌入模型 THEN 系统 SHALL 支持多种嵌入模型的配置和切换
3. WHEN 配置向量数据库 THEN 系统 SHALL 支持多种向量数据库后端
4. WHEN 调整检索参数 THEN 系统 SHALL 支持top_k、相似度阈值等参数配置
5. WHEN 性能优化 THEN 系统 SHALL 支持批量处理、缓存和并发控制

### 需求7：数据模型扩展

**用户故事：** 作为开发者，我需要扩展现有的数据模型以支持RAG功能的数据存储需求。

#### 验收标准

1. WHEN 存储文档块 THEN 系统 SHALL 创建DocumentChunk模型存储分块信息
2. WHEN 存储向量数据 THEN 系统 SHALL 创建DocumentEmbedding模型存储向量信息
3. WHEN 记录训练过程 THEN 系统 SHALL 扩展KnowledgeBase模型添加RAG相关字段
4. WHEN 查询历史 THEN 系统 SHALL 记录检索查询和结果用于分析优化
5. WHEN 数据迁移 THEN 系统 SHALL 提供数据库迁移脚本支持平滑升级

### 需求8：权限和安全

**用户故事：** 作为系统，我需要确保RAG功能遵循现有的权限体系，保护数据安全。

#### 验收标准

1. WHEN 执行训练操作 THEN 系统 SHALL 检查用户是否有EDITOR权限
2. WHEN 执行查询操作 THEN 系统 SHALL 检查用户是否有VIEWER权限
3. WHEN 访问向量数据 THEN 系统 SHALL 确保数据访问符合权限控制
4. WHEN 记录操作日志 THEN 系统 SHALL 记录所有RAG相关操作的审计信息
5. WHEN 处理敏感数据 THEN 系统 SHALL 确保向量数据不泄露原始文档内容

## 技术约束

1. **架构兼容性**：必须与现有的FastAPI + SQLAlchemy架构兼容
2. **数据库支持**：支持SQLite和PostgreSQL数据库
3. **异步处理**：使用现有的Huey任务队列进行异步处理
4. **配置管理**：集成到现有的Settings配置系统
5. **错误处理**：使用现有的异常处理和日志系统
6. **权限系统**：完全集成现有的用户权限管理体系

## 性能要求

1. **文档处理**：支持单次处理100MB以内的文档
2. **向量化速度**：批量向量化速度不低于1000个文本块/分钟
3. **检索响应**：查询响应时间不超过2秒
4. **并发支持**：支持至少10个并发训练任务
5. **存储效率**：向量数据压缩率不低于50%

## 兼容性要求

1. **模型兼容**：支持OpenAI、智谱AI、硅基流动等主流嵌入模型
2. **格式支持**：支持PDF、Word、Excel、Markdown、HTML、TXT等常见文档格式
3. **向量数据库**：支持Chroma、Qdrant、Milvus等主流向量数据库
4. **API兼容**：保持现有知识库API的向后兼容性