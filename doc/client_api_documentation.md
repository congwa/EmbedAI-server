# WebSocket API for Clients (Protocol V2)

This document outlines the WebSocket protocol for real-time chat communication between clients and the server.

## Connection

- **Endpoint**: `ws://<server_address>/api/v1/ws/client/{chat_id}`
- **Parameters**:
  - `chat_id` (int, path): The ID of the chat session.
  - `client_id` (str, query): A unique identifier for the client instance.
  - `third_party_user_id` (int, query): The ID of the user.
- **Headers**:
  - `X-Trace-ID` (str, optional): A trace ID for request correlation.

## General Message Format

All messages exchanged over the WebSocket are JSON objects and follow this structure:

```json
{
  "type": "domain.action",
  "payload": { ... },
  "request_id": "unique_string_for_request" 
}
```

- `type` (string): Identifies the message's purpose, using a `domain.action` convention.
- `payload` (object): Contains the data relevant to the message type.
- `request_id` (string, optional): A unique ID generated by the client for requests that expect a response. The server will include this ID in its response message.

---

## Client-to-Server Events

### 1. Create Message

Sends a new chat message.

- **type**: `message.create`
- **payload**:
  - `content` (string): The text of the message.
- **Example**:
  ```json
  {
    "type": "message.create",
    "payload": {
      "content": "Hello, I need help with my order."
    }
  }
  ```

### 2. Request History

Requests a batch of previous messages.

- **type**: `history.request`
- **payload**:
  - `before_message_id` (int, optional): Fetches messages before this ID (for pagination).
  - `limit` (int, optional, default: 20): The maximum number of messages to return.
- **Example**:
  ```json
  {
    "type": "history.request",
    "payload": {
      "limit": 50
    },
    "request_id": "req-123"
  }
  ```

### 3. Start/Stop Typing Indicator

Notifies the server that the user is typing.

- **type**: `typing.start` or `typing.stop`
- **payload**:
  - `is_typing` (boolean): `true` when the user starts typing, `false` when they stop.
- **Example**:
  ```json
  {
    "type": "typing.start",
    "payload": { "is_typing": true }
  }
  ```

### 4. Mark Messages as Read

Notifies the server that messages have been read by the user.

- **type**: `message.read`
- **payload**:
  - `message_ids` (array of int): A list of message IDs that have been read.
- **Example**:
  ```json
  {
    "type": "message.read",
    "payload": {
      "message_ids": [101, 102]
    }
  }
  ```

---

## Server-to-Client Events

### 1. New Message

Broadcasts a new message to all participants in the chat.

- **type**: `message.new`
- **payload**:
  - `message` (object): The chat message object.
    - `id` (int)
    - `content` (string)
    - `message_type` (string: "user", "assistant", "admin", "system")
    - `created_at` (string: ISO 8601 format)
    - `sender_id` (int)
    - `doc_metadata` (object)

### 2. History Response

Sends a batch of historical messages in response to a `history.request`.

- **type**: `history.response`
- **request_id**: Matches the ID from the original request.
- **payload**:
  - `messages` (array of message objects): The list of historical messages.

### 3. Typing Indicator Update

Broadcasts a user's typing status.

- **type**: `typing.update`
- **payload**:
  - `sender` (object): Information about the user who is typing.
  - `is_typing` (boolean)

### 4. System Notification

Sends a system-level notification (e.g., user joins/leaves, mode changes).

- **type**: `notification.system`
- **payload**:
  - `level` (string: "info", "warning", "error")
  - `content` (string): The notification message.

### 5. Error Response

Sent when a client's request fails.

- **type**: `response.error`
- **request_id**: Matches the ID from the original request, if available.
- **payload**:
  - `code` (string): A machine-readable error code (e.g., `INVALID_PAYLOAD`).
  - `message` (string): A human-readable description of the error.