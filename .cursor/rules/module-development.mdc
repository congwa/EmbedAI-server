# æ¨¡å—å¼€å‘è§„èŒƒä¸æœ€ä½³å®è·µ

## ğŸ¯ æ¨¡å—å¼€å‘åŸåˆ™

### 1. åˆ†å±‚æ¶æ„ä¸¥æ ¼æ‰§è¡Œ
```
API Layer (app/api/v1/) â†’ Service Layer (app/services/) â†’ Model Layer (app/models/)
```

### 2. æ¨¡å—èŒè´£åˆ’åˆ†

#### APIå±‚èŒè´£
- **è·¯ç”±å®šä¹‰**: å®šä¹‰HTTPç«¯ç‚¹
- **å‚æ•°éªŒè¯**: ä½¿ç”¨Pydantic SchemaéªŒè¯è¾“å…¥
- **æƒé™æ£€æŸ¥**: éªŒè¯ç”¨æˆ·æƒé™
- **å“åº”æ ¼å¼åŒ–**: ç»Ÿä¸€å“åº”æ ¼å¼

#### Serviceå±‚èŒè´£  
- **ä¸šåŠ¡é€»è¾‘**: å®ç°æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
- **æ•°æ®æ“ä½œ**: é€šè¿‡Modelå±‚æ“ä½œæ•°æ®
- **å¤–éƒ¨æœåŠ¡**: è°ƒç”¨ç¬¬ä¸‰æ–¹APIæœåŠ¡
- **ç¼“å­˜ç®¡ç†**: ç®¡ç†Redisç¼“å­˜

#### Modelå±‚èŒè´£
- **æ•°æ®å®šä¹‰**: å®šä¹‰æ•°æ®åº“è¡¨ç»“æ„
- **å…³ç³»æ˜ å°„**: å®šä¹‰æ¨¡å‹é—´å…³ç³»
- **æŸ¥è¯¢ä¼˜åŒ–**: ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢

## ğŸ“ æ–‡ä»¶ç»„ç»‡è§„èŒƒ

### APIæ–‡ä»¶ç»“æ„
```python
# app/api/v1/admin/example.py
from fastapi import APIRouter, Depends, HTTPException
from app.services.example import ExampleService
from app.schemas.example import ExampleCreate, ExampleResponse
from app.core.auth import get_current_admin_user

router = APIRouter()

@router.post("/", response_model=ExampleResponse)
async def create_example(
    data: ExampleCreate,
    current_user = Depends(get_current_admin_user),
    service: ExampleService = Depends()
):
    return await service.create(data, current_user)
```

### Serviceæ–‡ä»¶ç»“æ„
```python
# app/services/example.py
from app.services.base import BaseService
from app.models.example import Example
from app.schemas.example import ExampleCreate
from app.core.logger import Logger

class ExampleService(BaseService):
    def __init__(self):
        super().__init__(Example)
    
    async def create(self, data: ExampleCreate, user):
        try:
            # ä¸šåŠ¡é€»è¾‘å®ç°
            instance = await self.create_instance(data, user)
            Logger.info(f"Created example: {instance.id}")
            return instance
        except Exception as e:
            Logger.error(f"Failed to create example: {str(e)}")
            raise
```

### Modelæ–‡ä»¶ç»“æ„
```python
# app/models/example.py
from sqlalchemy import Column, Integer, String, DateTime, ForeignKey
from sqlalchemy.orm import relationship
from app.models.database import Base
from datetime import datetime

class Example(Base):
    __tablename__ = "examples"
    
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, nullable=False)
    created_at = Column(DateTime, default=datetime.utcnow)
    user_id = Column(Integer, ForeignKey("users.id"))
    
    # å…³ç³»å®šä¹‰
    user = relationship("User", back_populates="examples")
```

## ğŸ”§ å¼€å‘æ¨¡å¼

### 1. ä¾èµ–æ³¨å…¥æ¨¡å¼
```python
# ä½¿ç”¨FastAPIçš„ä¾èµ–æ³¨å…¥ç³»ç»Ÿ
from fastapi import Depends

def get_example_service():
    return ExampleService()

@router.get("/")
async def get_examples(service: ExampleService = Depends(get_example_service)):
    return await service.get_all()
```

### 2. å·¥å‚æ¨¡å¼ (RAGæ¨¡å—)
```python
# app/rag/datasource/vector_factory.py
class VectorFactory:
    @staticmethod
    def create_vector_store(store_type: str, config: dict):
        if store_type == "chroma":
            return ChromaVectorStore(config)
        elif store_type == "qdrant":
            return QdrantVectorStore(config)
        else:
            raise ValueError(f"Unsupported vector store type: {store_type}")
```

### 3. ç­–ç•¥æ¨¡å¼ (æ£€ç´¢æ–¹æ³•)
```python
# app/rag/retrieval/retrieval_engine.py
class RetrievalEngine:
    def __init__(self, strategy: RetrievalStrategy):
        self.strategy = strategy
    
    async def retrieve(self, query: str, **kwargs):
        return await self.strategy.retrieve(query, **kwargs)
```

## ğŸ›¡ï¸ é”™è¯¯å¤„ç†è§„èŒƒ

### 1. ç»Ÿä¸€å¼‚å¸¸å¤„ç†
```python
# ä½¿ç”¨è‡ªå®šä¹‰å¼‚å¸¸
from app.core.exceptions import ValidationError, NotFoundError

async def get_example(example_id: int):
    example = await ExampleService().get_by_id(example_id)
    if not example:
        raise NotFoundError(f"Example {example_id} not found")
    return example
```

### 2. æ—¥å¿—è®°å½•
```python
from app.core.logger import Logger

async def create_example(data: ExampleCreate):
    try:
        Logger.info(f"Creating example: {data.name}")
        result = await ExampleService().create(data)
        Logger.info(f"Successfully created example: {result.id}")
        return result
    except Exception as e:
        Logger.error(f"Failed to create example: {str(e)}")
        raise
```

## âš¡ æ€§èƒ½ä¼˜åŒ–è§„èŒƒ

### 1. å¼‚æ­¥å¤„ç†
```python
# æ‰€æœ‰æ•°æ®åº“æ“ä½œå¿…é¡»å¼‚æ­¥
async def get_examples():
    return await ExampleService().get_all()

# æ‰¹é‡æ“ä½œ
async def create_examples_batch(data_list: List[ExampleCreate]):
    return await ExampleService().create_batch(data_list)
```

### 2. ç¼“å­˜ç­–ç•¥
```python
from app.core.redis_manager import RedisManager

class ExampleService(BaseService):
    async def get_by_id(self, example_id: int):
        # å…ˆæŸ¥ç¼“å­˜
        cache_key = f"example:{example_id}"
        cached = await RedisManager.get(cache_key)
        if cached:
            return cached
        
        # æŸ¥æ•°æ®åº“
        example = await super().get_by_id(example_id)
        if example:
            # è®¾ç½®ç¼“å­˜
            await RedisManager.set(cache_key, example, expire=3600)
        return example
```

### 3. æ•°æ®åº“ä¼˜åŒ–
```python
# ä½¿ç”¨ç´¢å¼•
class Example(Base):
    __tablename__ = "examples"
    
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, nullable=False, index=True)  # æ·»åŠ ç´¢å¼•
    user_id = Column(Integer, ForeignKey("users.id"), index=True)  # æ·»åŠ ç´¢å¼•

# ä½¿ç”¨é¢„åŠ è½½
async def get_examples_with_user():
    return await ExampleService().get_all_with_relationship("user")
```

## ğŸ“ ä»£ç è´¨é‡è¦æ±‚

### 1. ç±»å‹æ³¨è§£
```python
from typing import List, Optional, Dict, Any

async def get_examples(
    page: int = 1,
    size: int = 10,
    filters: Optional[Dict[str, Any]] = None
) -> List[Example]:
    return await ExampleService().get_paginated(page, size, filters)
```

### 2. æ–‡æ¡£å­—ç¬¦ä¸²
```python
async def create_example(data: ExampleCreate, user: User) -> Example:
    """
    åˆ›å»ºæ–°çš„ç¤ºä¾‹è®°å½•
    
    Args:
        data: ç¤ºä¾‹åˆ›å»ºæ•°æ®
        user: å½“å‰ç”¨æˆ·
        
    Returns:
        Example: åˆ›å»ºçš„ç¤ºä¾‹å®ä¾‹
        
    Raises:
        ValidationError: æ•°æ®éªŒè¯å¤±è´¥
        PermissionError: æƒé™ä¸è¶³
    """
    return await ExampleService().create(data, user)
```

### 3. å•å…ƒæµ‹è¯•
```python
# tests/test_example_service.py
import pytest
from app.services.example import ExampleService

@pytest.mark.asyncio
async def test_create_example():
    service = ExampleService()
    data = ExampleCreate(name="Test Example")
    result = await service.create(data)
    assert result.name == "Test Example"
```

## ğŸš¨ å¸¸è§é”™è¯¯é¿å…

1. **é¿å…å¾ªç¯å¯¼å…¥**: ä½¿ç”¨ä¾èµ–æ³¨å…¥è€Œä¸æ˜¯ç›´æ¥å¯¼å…¥
2. **é¿å…N+1æŸ¥è¯¢**: ä½¿ç”¨é¢„åŠ è½½å’Œæ‰¹é‡æŸ¥è¯¢
3. **é¿å…ç¡¬ç¼–ç **: ä½¿ç”¨é…ç½®æ–‡ä»¶ç®¡ç†å¸¸é‡
4. **é¿å…å¿½ç•¥å¼‚å¸¸**: å§‹ç»ˆå¤„ç†å¼‚å¸¸å¹¶è®°å½•æ—¥å¿—
5. **é¿å…åŒæ­¥é˜»å¡**: ä½¿ç”¨å¼‚æ­¥æ“ä½œå¤„ç†I/Oå¯†é›†å‹ä»»åŠ¡
description:
globs:
alwaysApply: false
---
